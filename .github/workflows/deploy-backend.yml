name: Deploy Flask Backend to EC2

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'flask-api/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # Manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./flask-api
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run tests
        working-directory: ./flask-api
        run: |
          pytest tests/ -v --tb=short
        continue-on-error: true # Don't fail deployment if tests fail
  
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'EOF'
            set -e
            
            # Navigate to application directory
            cd ${{ secrets.APP_DIR }}
            
            # Pull latest changes
            echo "üì• Pulling latest code..."
            git pull origin main || git pull origin master
            
            # Navigate to flask-api directory
            cd flask-api
            
            # Clean up unnecessary files to save disk space
            echo "üßπ Cleaning up unnecessary files..."
            find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find . -type f -name "*.pyc" -delete 2>/dev/null || true
            rm -rf htmlcov/ .coverage .pytest_cache/ chroma_db/ 2>/dev/null || true
            
            # Activate virtual environment or create if not exists
            if [ ! -d "venv" ]; then
              echo "üîß Creating virtual environment..."
              python3 -m venv venv
            fi
            
            source venv/bin/activate
            
            # Install/Update dependencies
            echo "üì¶ Installing dependencies..."
            pip install --upgrade pip
            pip install -r app/requirements.txt
            
            # Restart the application service
            echo "üîÑ Restarting application..."
            sudo systemctl restart flask-api || sudo supervisorctl restart flask-api || pkill -f "python.*main.py" && nohup python app/main.py > /dev/null 2>&1 &
            
            echo "‚úÖ Deployment completed successfully!"
          EOF
      
      - name: Health Check
        run: |
          sleep 5
          echo "üè• Performing health check..."
          curl -f http://${{ secrets.EC2_HOST }}:5000/health || echo "Health check endpoint not available"
      
      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
      
      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Backend deployment to EC2 successful!"
          else
            echo "‚ùå Backend deployment to EC2 failed!"
          fi
